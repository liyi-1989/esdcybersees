---
title: "Spatial Covariance"
author: "Yi Li"
date: "June 18, 2016"
output: pdf_document
---

# 1. Covariance by Threshoulding

## 1.1 Theory

In Bickel(2008) Covariance Estimation by Threshoulding, the estimator is 

$$\hat{Cov}=S1_{S>c}$$.



## 1.2 Application

Apply this in PCA with climate data, i.e. EOF. We reproduce the result of the Jan mean Temp based on GCM data. 

### 1.2.1 Without Threshoulding

```{r,echo=FALSE}
#setwd("/home/liyi/Documents/esdcybersees")
library(maptools)
data(wrld_simpl)
load("lonlat.RData")
```


```{r,echo=FALSE}
#============================ Plot EOF ==============================================
V5=read.table("./results_eof/ta_month_1_svd_eigenvectors_top_5.txt",sep=",")
L=read.table("./results_eof/ta_month_1_svd_eigenvalues.txt",sep=",")


V5=V5[,ncol(V5):1]
L=rev(L[,1])
L.sum=sum(L[L>0])
L5=L[1:5]


eof1=matrix(V5[,1],144,90,byrow = T)
eof2=matrix(V5[,2],144,90,byrow = T)
eof3=matrix(V5[,3],144,90,byrow = T)
eof4=matrix(V5[,4],144,90,byrow = T)
eof5=matrix(V5[,5],144,90,byrow = T)


# Lon=ifelse(lon<=180,lon,lon-360)
# Lon=Lon[c(73:144,1:72)]

par(mfrow=c(3,2),
    #    oma = c(1,1,0,0),
    mar = c(2,2,2,2))

image(Lon,lat,eof1[c(73:144,1:72),],main=paste0(round(L5[1]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof1[c(73:144,1:72),],add=T,col="purple")

image(Lon,lat,eof2[c(73:144,1:72),],main=paste0(round(L5[2]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof2[c(73:144,1:72),],add=T,col="purple")

image(Lon,lat,eof3[c(73:144,1:72),],main=paste0(round(L5[3]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof3[c(73:144,1:72),],add=T,col="purple")

image(Lon,lat,eof4[c(73:144,1:72),],main=paste0(round(L5[4]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof4[c(73:144,1:72),],add=T,col="purple")

image(Lon,lat,eof5[c(73:144,1:72),],main=paste0(round(L5[5]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof5[c(73:144,1:72),],add=T,col="purple")

plot(1:10,L[1:10]/L.sum,type="o",col="blue",main="Variance Explained")

```

### 1.2.2 With Threshoulding

```{r,echo=FALSE}

V5=read.table("./results_eof/ta_month_1_svd_threshold_1_eigenvectors_top_5.txt",sep=",")
L=read.table("./results_eof/ta_month_1_svd_threshold_1_eigenvalues.txt",sep=",")


V5=V5[,ncol(V5):1]
L=rev(L[,1])
L.sum=sum(L[L>0])
L5=L[1:5]


eof1=matrix(V5[,1],144,90,byrow = T)
eof2=matrix(V5[,2],144,90,byrow = T)
eof3=matrix(V5[,3],144,90,byrow = T)
eof4=matrix(V5[,4],144,90,byrow = T)
eof5=matrix(V5[,5],144,90,byrow = T)


# Lon=ifelse(lon<=180,lon,lon-360)
# Lon=Lon[c(73:144,1:72)]

par(mfrow=c(3,2),
    #    oma = c(1,1,0,0),
    mar = c(2,2,2,2))

image(Lon,lat,eof1[c(73:144,1:72),],main=paste0(round(L5[1]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof1[c(73:144,1:72),],add=T,col="purple")

image(Lon,lat,eof2[c(73:144,1:72),],main=paste0(round(L5[2]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof2[c(73:144,1:72),],add=T,col="purple")

image(Lon,lat,eof3[c(73:144,1:72),],main=paste0(round(L5[3]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof3[c(73:144,1:72),],add=T,col="purple")

image(Lon,lat,eof4[c(73:144,1:72),],main=paste0(round(L5[4]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof4[c(73:144,1:72),],add=T,col="purple")

image(Lon,lat,eof5[c(73:144,1:72),],main=paste0(round(L5[5]/L.sum,2)*100,"%"))
plot(wrld_simpl,add=T)
contour(Lon,lat,eof5[c(73:144,1:72),],add=T,col="purple")

plot(1:10,L[1:10]/L.sum,type="o",col="blue",main="Variance Explained")

```


# 2. Spatial Covariance

- Assume we label the station by row
- Assume the covariance is decrease with their distance

## 2.1 On Simulate Data

Simulate the data based on $$e^{-0.4||s_i-s_j||}$$ with 10 by 10 grids.

```{r,echo=FALSE}
par(mfrow=c(1,2),mar = c(2,2,2,2))
n=10
X_label=matrix(1:n^2,n,n,byrow = T)
C=matrix(0,n^2,n^2)

for(i1 in 1:n){
  for(j1 in 1:n){
    for(i2 in 1:n){
      for(j2 in 1:n){
        i=(i1-1)*n+j1
        j=(i2-1)*n+j2
        C[i,j]=exp(-0.4*base::norm(as.matrix(c(i1-i2,j1-j2)),type="2"))
      }
    }
  }
}

library(cape)
image(rotate.mat(C),main="S: Covariance Matrix Structure")
image(rotate.mat(X_label),main="X: 2D Spatial Stations Labels")
for(i in 1:n){
  for(j in 1:n){
    count=(i-1)*n+j
    text(j/(n-1)-0.1,1-i/(n-1)+0.1,count)
  }
}

CT=doubeltaper(C,10,10,a=1.4,b=1.4)
image(rotate.mat(C))
image(rotate.mat(CT))

CT1=doubeltaper(C,10,10,a=1.4,b=1.4,Axis=1)
CT2=doubeltaper(C,10,10,a=1.4,b=1.4,Axis=2)
image(rotate.mat(CT1))
image(rotate.mat(CT2))

CB=doubeltaper(C,10,10,a=1.4,b=1.4,method="banding")
image(rotate.mat(C))
image(rotate.mat(CB))
```


## 2.2 On Real Data

Real data based on Temp with 10 by 10 GCM grids. 

```{r,echo=FALSE}
par(mfrow=c(1,2),mar = c(2,2,2,2))
load("~/Documents/esdcybersees/results_eof/Scov.RData")
image(rotate.mat(Scov),main="Scov")
load("~/Documents/esdcybersees/results_eof/Scor.RData")
image(rotate.mat(Scor),main="Scor")
```

```{r}
par(mfrow=c(1,1))
load("~/Documents/esdcybersees/results_eof/Scor.RData")
image(rotate.mat(Scor),main="S")
```

